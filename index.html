<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secret Stuleja - ≈öwiƒÖteczne Losowanie</title>
    <meta
      name="description"
      content="Generator par ≈õwiƒÖtecznych online - Secret Santa"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --color-red: #d42426;
        --color-red-hover: #b31b1d;
        --color-green: #165b33;
        --color-gold: #f8b229;
        --color-snow: #f8f8f8;
        --color-dark: #2c3e50;
        --color-white: #ffffff;
        --color-border: #dddddd;
        --shadow-standard: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--color-green);
        color: var(--color-dark);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        box-sizing: border-box;
        display: flex;
        /* SVG background optimized */
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48ZyBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMiIvPjwvZz48L3N2Zz4=");
        overflow-x: hidden;
      }

      /* --- Components --- */

      /* Container */
      .app-container {
        background: var(--color-snow);
        max-width: 600px;
        width: 100%;
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-standard);
        position: relative;
        z-index: 10;
        border: 5px solid var(--color-red);
        margin: auto;
      }

      /* Typography */
      h1,
      h2,
      h3 {
        font-family: "Mountains of Christmas", cursive;
        color: var(--color-red);
        text-align: center;
        margin-top: 0;
      }

      h1 {
        font-size: 3em;
        text-shadow: 2px 2px var(--color-gold);
        line-height: 1.2;
      }

      .text-center {
        text-align: center;
      }
      .text-muted {
        font-size: 0.9em;
        color: #666;
      }
      .text-error {
        color: var(--color-red);
        font-weight: bold;
      }
      .mt-2 {
        margin-top: 20px;
      }
      .mb-1 {
        margin-bottom: 10px;
      }

      /* Sections */
      .card-section {
        margin-bottom: 25px;
        padding: 20px;
        background: var(--color-white);
        border-radius: 10px;
        border: 1px solid var(--color-border);
      }

      /* Inputs & Forms */
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      input,
      select {
        flex: 1;
        padding: 10px;
        border: 2px solid var(--color-green);
        border-radius: 5px;
        font-size: 16px;
        min-width: 100px;
      }

      /* Buttons */
      button {
        background-color: var(--color-red);
        color: var(--color-white);
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: transform 0.1s, background-color 0.2s;
        white-space: nowrap;
      }

      button:hover {
        background-color: var(--color-red-hover);
        transform: scale(1.05);
      }

      button:active {
        transform: scale(0.95);
      }

      button.btn-secondary {
        background-color: var(--color-green);
      }
      button.btn-small {
        font-size: 0.8em;
        padding: 5px 10px;
        margin-left: 10px;
      }
      button.btn-block {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
      }

      /* Lists */
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        background: #f0f0f0;
        margin: 5px 0;
        padding: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn-remove {
        color: var(--color-red);
        cursor: pointer;
        font-weight: bold;
        padding: 0 10px;
        background: none;
        border: none;
        font-size: 1.2em;
      }
      .btn-remove:hover {
        background: none;
        transform: scale(1.2);
      }

      /* Results */
      .result-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        flex-wrap: wrap;
        gap: 10px;
      }

      .blur-reveal {
        filter: blur(4px);
        cursor: help;
        transition: filter 0.3s;
      }
      .blur-reveal:hover {
        filter: blur(0);
      }

      /* Recipient View */
      .gift-box {
        font-size: 100px;
        cursor: pointer;
        animation: bounce 2s infinite;
        user-select: none;
      }

      .reveal-text {
        font-size: 2em;
        color: var(--color-green);
        font-weight: bold;
        margin-top: 20px;
        animation: fadeIn 1s forwards;
      }

      /* Utilities */
      .hidden {
        display: none !important;
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--color-dark);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 100;
      }
      .toast.show {
        opacity: 1;
      }

      /* Animations */
      .snowflake {
        position: fixed;
        top: -10px;
        color: #fff;
        user-select: none;
        z-index: 0;
        opacity: 0.7;
        pointer-events: none;
        animation-name: fall;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
      }

      @keyframes fall {
        to {
          transform: translateY(100vh);
        }
      }
      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-20px);
        }
        60% {
          transform: translateY(-10px);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="snow-container"></div>

    <main class="app-container">
      <!-- Admin View: Setting up the game -->
      <section id="admin-view">
        <header>
          <h1>Secret Stuleja üéÑ</h1>
          <p class="text-center">Generator par ≈õwiƒÖtecznych</p>
        </header>

        <div class="card-section">
          <h3>1. Dodaj Uczestnik√≥w</h3>
          <!-- Using a form allows native "Enter" key submission -->
          <form id="form-add-participant" class="input-group">
            <input
              type="text"
              id="input-participant-name"
              placeholder="Imiƒô uczestnika"
              autocomplete="off"
              required
            />
            <button type="submit">Dodaj</button>
          </form>
          <ul id="list-participants"></ul>
        </div>

        <div class="card-section">
          <h3>2. Zablokuj Pary (Opcjonalne)</h3>
          <p class="text-muted mb-1">Wybierz kto NIE MO≈ªE wylosowaƒá kogo.</p>
          <form id="form-add-exclusion" class="input-group">
            <select id="select-giver" required>
              <option value="" disabled selected>Kto...</option>
            </select>
            <span style="align-self: center; font-weight: bold">‚áè</span>
            <select id="select-receiver" required>
              <option value="" disabled selected>kogo.</option>
            </select>
            <button type="submit" class="btn-secondary">Zablokuj</button>
          </form>
          <ul id="list-exclusions"></ul>
        </div>

        <div class="text-center">
          <button id="btn-draw" class="btn-block">üéÖ LOSUJ PARY üéÖ</button>
          <p id="error-msg" class="text-error hidden mt-2"></p>
        </div>

        <div id="results-section" class="card-section hidden mt-2">
          <h3>3. Wyniki i Linki</h3>
          <p class="text-center text-muted">
            Skopiuj link i wy≈õlij go odpowiedniej osobie.
          </p>
          <div id="list-results"></div>
        </div>
      </section>

      <!-- Recipient View: Seeing the result -->
      <section id="recipient-view" class="hidden text-center">
        <header>
          <h1>Secret Stuleja üéÅ</h1>
          <h2>Cze≈õƒá <span id="display-santa-name"></span>!</h2>
        </header>
        <p>Jeste≈õ uczestnikiem tajnego losowania.</p>
        <p>Kliknij w prezent, aby zobaczyƒá, komu kupujesz prezent:</p>

        <div id="gift-box" class="gift-box">üéÅ</div>

        <div id="target-reveal" class="reveal-text hidden">
          Wylosowa≈Çe≈õ/a≈õ:<br />
          <span
            style="font-size: 1.5em; color: var(--color-red)"
            id="display-target-name"
          ></span>
          <br />üéÑ Powodzenia! üéÑ
        </div>
      </section>
    </main>

    <div id="toast" class="toast">Skopiowano do schowka!</div>

    <script>
      /**
       * Secret Santa Application
       * Refactored for Clean Code and Security (XSS prevention)
       */
      document.addEventListener("DOMContentLoaded", () => {
        // --- State Management ---
        const state = {
          participants: [],
          exclusions: [],
        };

        // --- DOM Elements ---
        const elements = {
          views: {
            admin: document.getElementById("admin-view"),
            recipient: document.getElementById("recipient-view"),
            results: document.getElementById("results-section"),
          },
          forms: {
            addParticipant: document.getElementById("form-add-participant"),
            addExclusion: document.getElementById("form-add-exclusion"),
          },
          inputs: {
            participantName: document.getElementById("input-participant-name"),
            giverSelect: document.getElementById("select-giver"),
            receiverSelect: document.getElementById("select-receiver"),
          },
          lists: {
            participants: document.getElementById("list-participants"),
            exclusions: document.getElementById("list-exclusions"),
            results: document.getElementById("list-results"),
          },
          buttons: {
            draw: document.getElementById("btn-draw"),
          },
          display: {
            error: document.getElementById("error-msg"),
            santaName: document.getElementById("display-santa-name"),
            targetName: document.getElementById("display-target-name"),
            giftBox: document.getElementById("gift-box"),
            revealArea: document.getElementById("target-reveal"),
          },
          snowContainer: document.getElementById("snow-container"),
          toast: document.getElementById("toast"),
        };

        // --- Initialization ---
        init();

        function init() {
          createSnowEffect();
          checkUrlParams();
          bindEvents();
        }

        function bindEvents() {
          elements.forms.addParticipant.addEventListener(
            "submit",
            handleAddParticipant
          );
          elements.forms.addExclusion.addEventListener(
            "submit",
            handleAddExclusion
          );
          elements.buttons.draw.addEventListener("click", handleDrawPairs);
          elements.display.giftBox.addEventListener("click", revealTarget);
        }

        // --- Logic: URL Parsing ---
        function checkUrlParams() {
          const urlParams = new URLSearchParams(window.location.search);
          const encodedSanta = urlParams.get("s");
          const encodedTarget = urlParams.get("t");

          if (encodedSanta && encodedTarget) {
            elements.views.admin.classList.add("hidden");
            elements.views.recipient.classList.remove("hidden");

            try {
              // Security Note: atob is not encryption, just encoding.
              const santa = decodeURIComponent(atob(encodedSanta));
              const target = decodeURIComponent(atob(encodedTarget));

              // Safe text insertion
              elements.display.santaName.textContent = santa;
              elements.display.targetName.textContent = target;
            } catch (e) {
              alert("B≈Çƒôdny link!");
              window.location.href = window.location.pathname;
            }
          }
        }

        // --- Logic: Participants ---
        function handleAddParticipant(e) {
          e.preventDefault();
          const name = elements.inputs.participantName.value.trim();

          if (!name) return;

          if (state.participants.includes(name)) {
            alert("Ta osoba jest ju≈º na li≈õcie!");
            return;
          }

          state.participants.push(name);
          elements.inputs.participantName.value = "";
          updateUI();
        }

        function removeParticipant(name) {
          state.participants = state.participants.filter((p) => p !== name);
          // Remove related exclusions
          state.exclusions = state.exclusions.filter(
            (ex) => ex.giver !== name && ex.receiver !== name
          );
          updateUI();
        }

        // --- Logic: Exclusions ---
        function handleAddExclusion(e) {
          e.preventDefault();
          const giver = elements.inputs.giverSelect.value;
          const receiver = elements.inputs.receiverSelect.value;

          if (giver && receiver && giver !== receiver) {
            const exists = state.exclusions.some(
              (ex) => ex.giver === giver && ex.receiver === receiver
            );
            if (!exists) {
              state.exclusions.push({ giver, receiver });
              updateUI();
            }
          }
        }

        function removeExclusion(index) {
          state.exclusions.splice(index, 1);
          updateUI();
        }

        // --- UI Updates ---
        function updateUI() {
          // 1. Render Participants List
          elements.lists.participants.innerHTML = "";
          state.participants.forEach((name) => {
            const li = document.createElement("li");
            li.textContent = name + " ";

            const removeBtn = document.createElement("button");
            removeBtn.className = "btn-remove";
            removeBtn.textContent = "√ó";
            removeBtn.onclick = () => removeParticipant(name); // Event delegation preferred in large apps, ok here

            li.appendChild(removeBtn);
            elements.lists.participants.appendChild(li);
          });

          // 2. Update Select Options
          const updateSelect = (selectElement) => {
            const currentVal = selectElement.value;
            selectElement.innerHTML =
              '<option value="" disabled selected>Wybierz...</option>';
            state.participants.forEach((name) => {
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              selectElement.appendChild(option);
            });
            // Restore selection if still valid
            if (state.participants.includes(currentVal)) {
              selectElement.value = currentVal;
            }
          };

          updateSelect(elements.inputs.giverSelect);
          updateSelect(elements.inputs.receiverSelect);

          // Set default placeholders again
          elements.inputs.giverSelect.firstElementChild.textContent = "Kto...";
          elements.inputs.receiverSelect.firstElementChild.textContent =
            "kogo.";

          // 3. Render Exclusions
          elements.lists.exclusions.innerHTML = "";
          state.exclusions.forEach((ex, index) => {
            const li = document.createElement("li");
            li.innerHTML = `<span><b>${escapeHtml(
              ex.giver
            )}</b> ‚áè <b>${escapeHtml(ex.receiver)}</b></span>`;

            const removeBtn = document.createElement("button");
            removeBtn.className = "btn-remove";
            removeBtn.textContent = "√ó";
            removeBtn.onclick = () => removeExclusion(index);

            li.appendChild(removeBtn);
            elements.lists.exclusions.appendChild(li);
          });

          // Hide results if data changed
          elements.views.results.classList.add("hidden");
        }

        // --- Logic: Drawing Algorithm ---
        function handleDrawPairs() {
          elements.display.error.classList.add("hidden");

          if (state.participants.length < 2) {
            showError("Potrzeba co najmniej 2 os√≥b!");
            return;
          }

          const result = generatePairs(state.participants, state.exclusions);

          if (!result) {
            showError(
              "Nie uda≈Ço siƒô dopasowaƒá. Za du≈ºo blokad lub za ma≈Ço os√≥b!"
            );
            return;
          }

          renderResults(result);
        }

        function generatePairs(participants, exclusions) {
          // Monte Carlo approach: Try shuffling until valid
          const maxAttempts = 2000;
          const givers = [...participants];
          let receivers = [];

          for (let attempt = 0; attempt < maxAttempts; attempt++) {
            receivers = [...participants];
            shuffleArray(receivers);

            let isValid = true;
            for (let i = 0; i < givers.length; i++) {
              const g = givers[i];
              const r = receivers[i];

              // Rule 1: Cannot draw self
              if (g === r) {
                isValid = false;
                break;
              }

              // Rule 2: Check exclusions
              const isBlocked = exclusions.some(
                (ex) => ex.giver === g && ex.receiver === r
              );
              if (isBlocked) {
                isValid = false;
                break;
              }
            }

            if (isValid) {
              return givers.map((giver, i) => ({
                giver,
                receiver: receivers[i],
              }));
            }
          }
          return null; // Failed to find solution
        }

        function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
        }

        function renderResults(pairs) {
          const container = elements.lists.results;
          container.innerHTML = "";

          pairs.forEach((pair) => {
            const safeGiver = btoa(encodeURIComponent(pair.giver));
            const safeReceiver = btoa(encodeURIComponent(pair.receiver));
            const baseUrl = window.location.href.split("?")[0];
            const link = `${baseUrl}?s=${safeGiver}&t=${safeReceiver}`;

            const row = document.createElement("div");
            row.className = "result-row";

            // Use textContent/innerText for safety
            const infoDiv = document.createElement("div");
            infoDiv.style.flex = "1";

            const strong = document.createElement("strong");
            strong.textContent = pair.giver;

            const arrowText = document.createTextNode(" ‚ûî ");

            const secretSpan = document.createElement("span");
            secretSpan.className = "blur-reveal";
            secretSpan.textContent = "???";
            secretSpan.title = pair.receiver;

            infoDiv.appendChild(strong);
            infoDiv.appendChild(arrowText);
            infoDiv.appendChild(secretSpan);

            const copyBtn = document.createElement("button");
            copyBtn.className = "btn-secondary btn-small";
            copyBtn.textContent = "Kopiuj Link";
            copyBtn.onclick = () => copyToClipboard(link);

            row.appendChild(infoDiv);
            row.appendChild(copyBtn);
            container.appendChild(row);
          });

          elements.views.results.classList.remove("hidden");
          setTimeout(() => {
            elements.views.results.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }, 100);
        }

        // --- Visual Effects ---
        function revealTarget() {
          elements.display.giftBox.style.display = "none";
          elements.display.revealArea.classList.remove("hidden");
          createConfetti();
        }

        function createSnowEffect() {
          const count = 50;
          for (let i = 0; i < count; i++) {
            const snowflake = document.createElement("div");
            snowflake.classList.add("snowflake");
            snowflake.textContent = "‚ùÑ";
            snowflake.style.left = Math.random() * 100 + "vw";
            snowflake.style.animationDuration = Math.random() * 3 + 2 + "s";
            snowflake.style.fontSize = Math.random() * 10 + 10 + "px";
            elements.snowContainer.appendChild(snowflake);
          }
        }

        function createConfetti() {
          const colors = ["#D42426", "#165B33", "#F8B229"];
          for (let i = 0; i < 30; i++) {
            const el = document.createElement("div");
            Object.assign(el.style, {
              position: "fixed",
              top: "50%",
              left: "50%",
              width: "10px",
              height: "10px",
              backgroundColor:
                colors[Math.floor(Math.random() * colors.length)],
              zIndex: "100",
            });

            document.body.appendChild(el);

            const angle = Math.random() * 360;
            const velocity = Math.random() * 200 + 50;
            const rad = angle * (Math.PI / 180);
            const x = Math.cos(rad) * velocity;
            const y = Math.sin(rad) * velocity;

            const animation = el.animate(
              [
                { transform: `translate(0,0)` },
                { transform: `translate(${x}px, ${y}px)`, opacity: 0 },
              ],
              { duration: 1000, easing: "ease-out" }
            );

            animation.onfinish = () => el.remove();
          }
        }

        // --- Helpers ---
        function copyToClipboard(text) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              const t = elements.toast;
              t.classList.add("show");
              setTimeout(() => t.classList.remove("show"), 2000);
            })
            .catch((err) => {
              console.error("Failed to copy", err);
              prompt("Skopiuj link rƒôcznie:", text);
            });
        }

        function showError(msg) {
          elements.display.error.textContent = msg;
          elements.display.error.classList.remove("hidden");
        }

        function escapeHtml(text) {
          const map = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          };
          return text.replace(/[&<>"']/g, (m) => map[m]);
        }
      });
    </script>
  </body>
</html>
